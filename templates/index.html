{% extends 'layout.html' %}
{% block title %}Neutralising Titre Automator{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center text-success mb-4">Neutralising Titre Automator</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form action="{{ url_for('process') }}" method="post" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="csv_file" class="form-label">Upload CSV File</label>
      <input type="file" name="csv_file" id="csv_file" class="form-control" accept=".csv" required>
    </div>

    <div class="mb-3">
      <label for="assay_title" class="form-label">Assay Title</label>
      <input type="text" name="assay_title" id="assay_title" class="form-control" placeholder="e.g. Neutralisation Assay 1">
    </div>

    <div class="mb-3">
      <label for="num_pseudotypes" class="form-label">Pseudotypes per Plate</label>
      <select name="num_pseudotypes" id="num_pseudotypes" class="form-select" required>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="pseudotype_text" class="form-label">Pseudotype(s)</label>
      <input type="text" name="pseudotype_text" id="pseudotype_text" class="form-control" placeholder="e.g. Alpha, Beta" required>
    </div>

    <div class="mb-3">
      <label for="sample_id_text" class="form-label">Sample ID(s)</label>
      <input type="text" name="sample_id_text" id="sample_id_text" class="form-control" placeholder="e.g. Sample 1, Sample 2">
    </div>

    <button type="submit" class="btn btn-success w-100">ðŸš€ Process File ðŸš€</button>
  </form>



  <hr class="my-4">

<div class="card">
  <div class="card-body small">
    <h6 class="text-muted fw-bold">Current Configuration</h6>
    <ul class="mb-0">
      <li><strong>Template:</strong> {{ settings.template_path.split('/')[-1] if settings.template_path else 'None' }}</li>
      <li><strong>Timestamp in Filename:</strong> {{ "Yes" if settings.timestamp_in_filename else "No" }}</li>
      <li><strong>Graph Colours ({{ settings.selected_preset }}):</strong>
        <ul class="mb-0">
          <li>Q1: <span style="color: {{ settings.presets[settings.selected_preset].Q1 }}">{{ settings.presets[settings.selected_preset].Q1 }}</span></li>
          <li>Q2: <span style="color: {{ settings.presets[settings.selected_preset].Q2 }}">{{ settings.presets[settings.selected_preset].Q2 }}</span></li>
          <li>Q3: <span style="color: {{ settings.presets[settings.selected_preset].Q3 }}">{{ settings.presets[settings.selected_preset].Q3 }}</span></li>
          <li>Q4: <span style="color: {{ settings.presets[settings.selected_preset].Q4 }}">{{ settings.presets[settings.selected_preset].Q4 }}</span></li>
        </ul>
      </li>
      <li><strong>Quadrants Included in Plots:</strong>
        <ul class="mb-0">
          <li>Q1: {{ 'Yes' if settings.quadrants and settings.quadrants.get('Q1') else 'No' }}</li>
          <li>Q2: {{ 'Yes' if settings.quadrants and settings.quadrants.get('Q2') else 'No' }}</li>
          <li>Q3: {{ 'Yes' if settings.quadrants and settings.quadrants.get('Q3') else 'No' }}</li>
          <li>Q4: {{ 'Yes' if settings.quadrants and settings.quadrants.get('Q4') else 'No' }}</li>

        </ul>
      </li>
    </ul>
  </div>
</div>




</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const numPseudotypesSelect = document.getElementById('num_pseudotypes');
  const pseudotypeInput = document.getElementById('pseudotype_text');
  const assayTitleInput = document.getElementById('assay_title');
  const sampleIdInput = document.getElementById('sample_id_text');

  // Restore form data from sessionStorage
  const savedData = sessionStorage.getItem('formData');
  if (savedData) {
    const data = JSON.parse(savedData);
    if (data.assay_title) assayTitleInput.value = data.assay_title;
    if (data.num_pseudotypes) numPseudotypesSelect.value = data.num_pseudotypes;
    if (data.pseudotype_text) pseudotypeInput.value = data.pseudotype_text;
    if (data.sample_id_text) sampleIdInput.value = data.sample_id_text;
  }

  // Save form data whenever inputs change
  function saveFormData() {
    const formData = {
      assay_title: assayTitleInput.value,
      num_pseudotypes: numPseudotypesSelect.value,
      pseudotype_text: pseudotypeInput.value,
      sample_id_text: sampleIdInput.value
    };
    sessionStorage.setItem('formData', JSON.stringify(formData));
  }

  // Add event listeners to save on change
  assayTitleInput.addEventListener('input', saveFormData);
  numPseudotypesSelect.addEventListener('change', saveFormData);
  pseudotypeInput.addEventListener('input', saveFormData);
  sampleIdInput.addEventListener('input', saveFormData);

  // Form validation on submit
  form.addEventListener('submit', function(e) {
    const numPseudotypes = parseInt(numPseudotypesSelect.value);
    const pseudotypeText = pseudotypeInput.value.trim();
    
    if (!pseudotypeText) {
      e.preventDefault();
      alert('Please enter at least one pseudotype name.');
      pseudotypeInput.focus();
      return false;
    }

    const pseudotypes = pseudotypeText.split(',').map(pt => pt.trim()).filter(pt => pt);
    
    if (pseudotypes.length < numPseudotypes) {
      const proceed = confirm(
        `Warning: You selected ${numPseudotypes} pseudotype(s) but only entered ${pseudotypes.length}. ` +
        `Missing pseudotypes will be labelled as "Unlabelled". Continue?`
      );
      if (!proceed) {
        e.preventDefault();
        pseudotypeInput.focus();
        return false;
      }
    }
    
    // Clear saved data on successful submit
    // sessionStorage.removeItem('formData');
  });
});
</script>

{% endblock %}